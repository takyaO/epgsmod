<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>EPGSmod</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; background: #f4f4f4; }
    h1 { font-size: 1.4rem; text-align: center; }
    .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    select,input,button { width: 100%; margin-top: 10px; padding: 10px; }
    #log { background: black; color: #0f0; padding: 10px; height: 150px; overflow-y: auto; }
</style>
</head>
<body>

<h1>ğŸ“º ã‚¸ãƒ£ãƒ³ãƒ«æ¤œç´¢ & äºˆç´„</h1>

<div class="card">
    <h3>ğŸŒ EPGStationè¨­å®š</h3>
    <input type="url" id="epgApiUrl" value="http://localhost:8888" placeholder="ä¾‹: http://localhost:8888">
    <button onclick="saveApiUrl()">URLã‚’ä¿å­˜</button>
</div>

<div class="card">
    <h3>1. ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠ</h3>
    <select id="limitSelect">
      <option value="10">10 ä»¶</option>
      <option value="50">50 ä»¶</option>
      <option value="100">100 ä»¶</option>
      <option value="200" selected>200 ä»¶</option>
    </select>
    <select id="genreSelect"></select>
    <button onclick="searchSchedules()">æ¤œç´¢</button>
</div>

<div class="card">
    <h3>2. ç•ªçµ„é¸æŠ</h3>

    <select id="programList" size="6" onchange="selectProgram()"></select>

    <!-- â˜… ã€Œ[æ–°]ã®ã¿è¡¨ç¤ºã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
<div style="margin-top:6px;">
    <label style="display:flex; align-items:center; gap:4px; font-size:13px; white-space:nowrap;">
        <input type="checkbox" id="filterNewCheck" onchange="filterNewOnly()" style="margin:0;">
        ï¼»æ–°ï¼½ã®ã¿è¡¨ç¤º
    </label>
</div>


</div>


<div class="card">
    <h3>3. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰éŒ²ç”»ãƒ«ãƒ¼ãƒ«è¿½åŠ </h3>

    <input id="keywordInput" placeholder="ç•ªçµ„åãŒå…¥ã‚Šã¾ã™" style="width:100%; margin-bottom:8px;">

    <!-- æ¨ªä¸¦ã³ã®æ¤œç´¢ãƒœã‚¿ãƒ³ -->
    <div id="keywordSearchButtons" style="
        display: flex;
        gap: 6px;
        margin: 6px 0;
    ">
        <button class="mini-btn" onclick="searchExternal('duck')">DuckDuckGo</button>
        <button class="mini-btn" onclick="searchExternal('google')">Google</button>
        <button class="mini-btn" onclick="searchExternal('wiki')">Wikipedia</button>
    </div>

    <!-- æ¨ªã„ã£ã±ã„ã®éŒ²ç”»ãƒ«ãƒ¼ãƒ«è¿½åŠ ãƒœã‚¿ãƒ³ -->
    <button onclick="addRule()" style="
        width: 100%;
        padding: 10px;
        font-size: 15px;
        margin-top: 6px;
    ">
        éŒ²ç”»ãƒ«ãƒ¼ãƒ«è¿½åŠ 
    </button>
</div>
<div class="card">
    <h3>4. ç«¶åˆãƒã‚§ãƒƒã‚¯</h3>
    <div style="margin-bottom: 10px; font-size: 0.9rem; color: #666;">
        ç«¶åˆã«ã‚ˆã‚Šäºˆç´„ã§ããªã‹ã£ãŸç•ªçµ„ã¨ã€ãã®åŸå› ã¨ãªã£ã¦ã„ã‚‹äºˆç´„ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
    </div>
    <button onclick="checkConflicts()" style="background-color: #d9534f; color: white;">
        âš  ç«¶åˆã‚’ç¢ºèªã™ã‚‹
    </button>
    <div id="conflictList" style="margin-top:15px;"></div>
</div>

<div class="card">
    <h3>ãƒ­ã‚°</h3>
    <div id="log">Ready...</div>
</div>


<script src="extractProgram.js"></script>
<script>
// ====================================================================
// â–¼â–¼â–¼ API URLç®¡ç†ã®ãŸã‚ã®å¤‰æ•°ã®å®šç¾©ã¨é–¢æ•°ã®è¿½åŠ  â–¼â–¼â–¼
// ====================================================================

// APIãƒ™ãƒ¼ã‚¹URLã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let EPG_API_BASE = 'http://localhost:8888'; 
let originalProgramList = [];
  
// URLå…¥åŠ›æ¬„ã®å€¤ã‚’èª­ã¿è¾¼ã¿ã€å¤‰æ•°ã¨LocalStorageã«ä¿å­˜ã™ã‚‹é–¢æ•°
function saveApiUrl() {
    const inputElement = document.getElementById('epgApiUrl');
    // æœ«å°¾ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã€å¤‰æ•°ã«æ ¼ç´
    EPG_API_BASE = inputElement.value.trim().replace(/\/$/, ''); 
    alert(`EPGStation API URLã‚’ ${EPG_API_BASE} ã«è¨­å®šã—ã¾ã—ãŸã€‚`);
    // LocalStorageã«ä¿å­˜
    localStorage.setItem('epgApiUrl', EPG_API_BASE);
    log(`API URLè¨­å®š: ${EPG_API_BASE}`);
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
document.addEventListener('DOMContentLoaded', () => {
    const savedUrl = localStorage.getItem('epgApiUrl');
    const inputElement = document.getElementById('epgApiUrl');
    
    // LocalStorageã«ä¿å­˜ã•ã‚ŒãŸURLãŒã‚ã‚Œã°å¾©å…ƒ
    if (savedUrl && inputElement) {
        inputElement.value = savedUrl;
        EPG_API_BASE = savedUrl;
    }
    log(`åˆæœŸAPI URL: ${EPG_API_BASE}`);
    
    // æ—¢å­˜ã®ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠè‚¢ã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
    const genreSelect = document.getElementById('genreSelect');
    for (const [k,v] of Object.entries(genreMap)) {
        const op = document.createElement('option');
        op.value = k; op.textContent = v;
        genreSelect.appendChild(op);
    }
    genreSelect.value = "7";
});


// ====================================================================
// â–²â–²â–² API URLç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚ã‚ã‚Š â–²â–²â–²
// ====================================================================

const genreMap = {
    0:"ãƒ‹ãƒ¥ãƒ¼ã‚¹",1:"ã‚¹ãƒãƒ¼ãƒ„",2:"æƒ…å ±",3:"ãƒ‰ãƒ©ãƒ",
    4:"éŸ³æ¥½",5:"ãƒãƒ©ã‚¨ãƒ†ã‚£",6:"æ˜ ç”»",7:"ã‚¢ãƒ‹ãƒ¡/ç‰¹æ’®",
    8:"ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼",9:"åŠ‡å ´/å…¬æ¼”",10:"è¶£å‘³/æ•™è‚²",11:"ç¦ç¥‰"
};

// genreSelectã®åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯ã¯DOMContentLoadedå†…ã«ç§»å‹•ã—ã¾ã—ãŸ

function log(msg){
    const el = document.getElementById('log');
    el.innerText = `[${new Date().toLocaleTimeString()}] ${msg}\n` + el.innerText;
}

async function searchSchedules(){
    const genreId = Number(genreSelect.value);

    // â˜… ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã® limit ã‚’å–å¾—
    const limit = Number(document.getElementById('limitSelect').value);

    const payload = {
        epgApiBase: EPG_API_BASE,
        isHalfWidth: false,
        option: {
            keyword: "",
            name: true, description: true, extended: true,
            GR: true, BS: true, CS: true, SKY: true,

            // subGenre ã‚’å¤–ã™ï¼ˆä»»æ„æ‰±ã„ï¼‰
            genres: [{ genre: genreId }]
        },

        // â˜… é¸æŠã•ã‚ŒãŸ limit ã‚’åæ˜ 
        limit: limit
    };

    try {
        const res = await fetch('/proxy/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (data && data.error) {
            log("æ¤œç´¢ã‚¨ãƒ©ãƒ¼: " + data.error);
            alert("æ¤œç´¢å¤±æ•—: " + data.error);
            return;
        }

        updateList(data);
        log(`æ¤œç´¢å®Œäº†: ${data.length} ä»¶`);
    } catch(e){
        log("æ¤œç´¢ã‚¨ãƒ©ãƒ¼: " + e.message);
        alert("æ¤œç´¢å¤±æ•—");
    }
}


function updateList(list){
    const box = document.getElementById('programList');
    box.innerHTML = "";

    if (!Array.isArray(list)) {
        originalProgramList = [];
        return;
    }

    // 1) å—ã‘å–ã£ãŸä¸€è¦§ã‚’åŸæœ¬ã¨ã—ã¦ä¿æŒï¼ˆfilteråˆ‡æ›¿ã«ä½¿ç”¨ï¼‰
    originalProgramList = list.slice();

    // 2) åå‰æœ‰ã‚Šã®è¦ç´ ã ã‘å–ã‚Šå‡ºã—ã¦æ—¥æœ¬èªã‚½ãƒ¼ãƒˆ
    const filteredAndSorted = originalProgramList
        .filter(p => p && p.name) // p ãŒå­˜åœ¨ã— name ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
        .sort((a, b) => a.name.localeCompare(b.name, 'ja'));
    
    // â–¼è¿½åŠ : æ›œæ—¥ã®å®šç¾©
    const wdayList = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

    // 3) è¡¨ç¤ºç”¨ã« option ã‚’ä½œæˆï¼ˆé–‹å§‹æ—¥æ™‚ãŒã‚ã‚Œã°è¡¨ç¤ºã«å«ã‚ã‚‹ï¼‰
    filteredAndSorted.forEach(p => {
        const op = document.createElement('option');

        // startAt ãŒã‚ã‚‹ï¼æœ‰åŠ¹ãªæ—¥ä»˜ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        let startTime = "";
        if (p.startAt) {
            const d = new Date(p.startAt);
            if (!Number.isNaN(d.getTime())) {
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                const hh = String(d.getHours()).padStart(2, '0');
                const mi = String(d.getMinutes()).padStart(2, '0');
                
                // â–¼è¿½åŠ : æ›œæ—¥ã‚’å–å¾—
                const wday = wdayList[d.getDay()];

                // â–¼å¤‰æ›´: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«æ›œæ—¥ã‚’è¿½åŠ  (ä¾‹: 12/10(æ°´) 18:00)
                startTime = `${mm}/${dd}(${wday}) ${hh}:${mi}`; 
            }
        }

        op.value = p.name; // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã«ä½¿ã†å€¤ã¯ç•ªçµ„åã®ã¿
        op.textContent = startTime ? `[${startTime}] ${p.name}` : p.name;
        box.appendChild(op);
    });

    // 4) ç¾åœ¨ã€Œï¼»æ–°ï¼½ã®ã¿è¡¨ç¤ºã€ãŒã‚ªãƒ³ãªã‚‰çµã‚Šè¾¼ã‚€ï¼ˆåˆ‡æ›¿å¾Œã‚‚ä¸€è²«ã—ã¦å‹•ã‹ã™ãŸã‚ï¼‰
    const chk = document.getElementById('filterNewCheck');
    if (chk && chk.checked) {
        filterNewOnly(); // æ—¢ã«ç”¨æ„ã—ãŸé–¢æ•°ã‚’åˆ©ç”¨
    }
}

function filterNewOnly() {
    const listBox = document.getElementById("programList");
    listBox.innerHTML = "";

    if (!Array.isArray(originalProgramList)) return;

    const filter = document.getElementById('filterNewCheck').checked;

    let filtered = originalProgramList;
    if (filter) {
        filtered = originalProgramList.filter(x => {
            const n = x && x.name ? x.name : "";
            return n.includes("ï¼»æ–°ï¼½") || n.includes("[æ–°]");
        });
    }

    filtered.forEach(p => {
        if (!p || !p.name) return;
        const op = document.createElement("option");

        let startTime = "";
        if (p.startAt) {
            const d = new Date(p.startAt);
            if (!Number.isNaN(d.getTime())) {
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                const hh = String(d.getHours()).padStart(2, '0');
                const mi = String(d.getMinutes()).padStart(2, '0');
                startTime = `${mm}/${dd} ${hh}:${mi}`;
            }
        }

        op.value = p.name;
        op.textContent = startTime ? `[${startTime}] ${p.name}` : p.name;
        listBox.appendChild(op);
    });
}
    
function selectProgram(){
    // å…ƒã®å‡¦ç†:
//    document.getElementById('keywordInput').value = document.getElementById('programList').value;
    
    // â–¼â–¼â–¼ å¤‰æ›´: ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’é€šã—ã¦ã‹ã‚‰ã‚»ãƒƒãƒˆã™ã‚‹ â–¼â–¼â–¼
    const rawName = document.getElementById('programList').value;
    const cleanName = extractProgram(rawName);
    document.getElementById('keywordInput').value = cleanName;
}

async function addRule(){
    const keyword = document.getElementById('keywordInput').value;
    if (!keyword) return alert("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›");
    
    if (!EPG_API_BASE || EPG_API_BASE.trim() === '') {
        log("ã‚¨ãƒ©ãƒ¼: EPG API URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        alert("EPG API URLã‚’è¨­å®šã—ã€[URLã‚’ä¿å­˜]ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    if (!confirm(`ã€Œ${keyword}ã€ã‚’ãƒ«ãƒ¼ãƒ«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) return;

    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: EPG_API_BASEã‚’JSONãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ  â˜…â˜…â˜…
    const payload = {
        // EPG_API_BASEã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¼ãˆã‚‹ãŸã‚ã«è¿½åŠ 
        epgApiBase: EPG_API_BASE, 
        
        isTimeSpecification: false,
        searchOption: {
            keyword,
            name: true, description: true, extended: true,
            GR: true, BS: true, CS: true
        },
        reserveOption: {
            enable: true,
            allowEndLack: false,
            avoidDuplicate: true
        }
    };

    try {
        const r = await fetch('/proxy/rule', {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const data = await r.json();
        
        if (data && data.error) {
            log(`è¿½åŠ ã‚¨ãƒ©ãƒ¼: ${data.error}`);
            alert(`è¿½åŠ å¤±æ•—: ${data.error}`);
            return;
        }

        log(`è¿½åŠ  OK: ãƒ«ãƒ¼ãƒ«ID ${data.id}`);
        alert("è¿½åŠ ã—ã¾ã—ãŸï¼");
    } catch(e){
        log("è¿½åŠ ã‚¨ãƒ©ãƒ¼: " + e.message);
        alert("è¿½åŠ å¤±æ•—");
    }
}
function searchExternal(type) {
    const keyword = document.getElementById('keywordInput').value.trim();
    if (!keyword) {
        alert("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
    }

    let url = "";
    const q = encodeURIComponent(keyword);

    switch (type) {
        case "duck":
            url = `https://duckduckgo.com/?q=${q}`;
            break;
        case "google":
            url = `https://www.google.com/search?q=${q}`;
            break;
        case "wiki":
            url = `https://ja.wikipedia.org/wiki/Special:Search?search=${q}`;
            break;
    }

    window.open(url, "_blank");
}
// â–¼â–¼â–¼ 4. ç«¶åˆãƒ«ãƒ¼ãƒ«ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ â–¼â–¼â–¼

/**
 * ç«¶åˆæƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
 */
async function checkConflicts() {
    const logDiv = document.getElementById('log');
    const listDiv = document.getElementById('conflictList');
    const apiUrl = document.getElementById('epgApiUrl').value.replace(/\/$/, '');

    listDiv.innerHTML = '<p>æ¤œç´¢ä¸­...</p>';
    logDiv.innerText = 'ç«¶åˆæƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™(ProxyçµŒç”±)...';

    try {
        // 1. ç«¶åˆã§è½ã¡ãŸäºˆç´„ã‚’å–å¾— (ProxyçµŒç”±)
        const conflictData = await fetchReservesViaProxy(apiUrl, 'conflict');
        
        // 2. æœ‰åŠ¹ãªäºˆç´„ã‚’å–å¾— (ProxyçµŒç”±)
        const activeData = await fetchReservesViaProxy(apiUrl, 'normal');

        const lostReserves = conflictData.reserves || [];
        const keptReserves = activeData.reserves || [];

        listDiv.innerHTML = ''; // ã‚¯ãƒªã‚¢

        if (lostReserves.length === 0) {
            listDiv.innerHTML = '<p style="text-align:center; color:#28a745;">ç¾åœ¨ã€ç«¶åˆã—ã¦ã„ã‚‹äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            logDiv.innerText = 'ç«¶åˆãªã—';
            return;
        }

        // 3. ãƒãƒƒãƒãƒ³ã‚°å‡¦ç†ã¨è¡¨ç¤º (ã“ã“ã¯å¤‰æ›´ãªã—)
        let count = 0;
        lostReserves.forEach(lost => {
            const enemies = keptReserves.filter(kept => {
                return (lost.startAt < kept.endAt) && (lost.endAt > kept.startAt);
            });

            if (enemies.length > 0) {
                count++;
                const card = createConflictCard(lost, enemies);
                listDiv.appendChild(card);
            }
        });

        if (count === 0) {
             listDiv.innerHTML = '<p>ç«¶åˆãƒªã‚¹ãƒˆã«ã¯ã‚ã‚Šã¾ã™ãŒã€ç¾åœ¨ã®æœ‰åŠ¹äºˆç´„ã¨é‡ãªã‚‹ã‚‚ã®ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
        }
        logDiv.innerText = `ç«¶åˆãƒã‚§ãƒƒã‚¯å®Œäº†: ${count} ä»¶ã®ç«¶åˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚`;

    } catch (err) {
        console.error(err);
        listDiv.innerHTML = `<p style="color:red">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}</p>`;
        logDiv.innerText = `ã‚¨ãƒ©ãƒ¼: ${err.message}`;
    }
}

/**
 * ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§äºˆç´„ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 */
async function fetchReservesViaProxy(epgApiBase, type) {
    const limit = type === 'conflict' ? 50 : 2000;
    
    // æ¤œç´¢æ©Ÿèƒ½ã¨åŒã˜å½¢å¼ã§ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆ
    const payload = {
        epgApiBase: epgApiBase,
        type: type,
        limit: limit
    };

    const res = await fetch('/proxy/reserves', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    if (!res.ok) {
        const errText = await res.text();
        throw new Error(`Server Error (${res.status}): ${errText}`);
    }
    return await res.json();
}

/**
 * äºˆç´„å‰Šé™¤ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•° (ProxyçµŒç”±)
 */
async function deleteReserve(reserveId, name) {
    if(!confirm(`ä»¥ä¸‹ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã€Œ${name}ã€`)) return;

    const logDiv = document.getElementById('log');
    const apiUrl = document.getElementById('epgApiUrl').value.replace(/\/$/, '');

    try {
        const payload = {
            epgApiBase: apiUrl,
            reserveId: reserveId
        };

        const res = await fetch('/proxy/reserves/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            logDiv.innerText = `å‰Šé™¤æˆåŠŸ: ${name}`;
            alert('å‰Šé™¤ã—ã¾ã—ãŸã€‚ç«¶åˆãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã™ã€‚');
            checkConflicts(); // ãƒªã‚¹ãƒˆå†å–å¾—
        } else {
            throw new Error(`Status: ${res.status}`);
        }
    } catch (err) {
        alert(`å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
        logDiv.innerText = `å‰Šé™¤å¤±æ•—: ${err.message}`;
    }
}

function createConflictCard(lost, enemies) {
    const container = document.createElement('div');
    container.style.cssText = "border:1px solid #ccc; padding:10px; margin-bottom:10px; border-radius:4px; background-color:#fff0f0;";

    // A. éŒ²ç”»ã§ããªã‹ã£ãŸç•ªçµ„
    let html = `
        <div style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px dashed #ccc;">
            <div style="font-weight:bold; color:#d9534f;">âŒ éŒ²ç”»ä¸å¯ (ç«¶åˆ):</div>
            <div style="font-size:1.1em;">${lost.name}</div>
            <div style="font-size:0.85em; color:#555;">${formatTimeRange(lost.startAt, lost.endAt)}</div>
            <div style="margin-top:5px;">
                <button onclick="deleteReserve(${lost.id}, '${lost.name}')" class="mini-btn" style="background:#666; color:white;">äºˆç´„å–æ¶ˆ</button>
            </div>
        </div>
    `;

    // B. åŸå› ã®ç•ªçµ„
    html += `<div style="font-weight:bold; color:#28a745; margin-bottom:5px;">âœ… å„ªå…ˆã•ã‚ŒãŸäºˆç´„ (åŸå› ):</div>`;
    enemies.forEach(enemy => {
        html += `
            <div style="background:white; padding:8px; border-radius:4px; margin-bottom:5px; border-left: 4px solid #28a745;">
                <div>${enemy.name}</div>
                <div style="font-size:0.85em; color:#555;">${formatTimeRange(enemy.startAt, enemy.endAt)}</div>
                <button onclick="deleteReserve(${enemy.id}, '${enemy.name}')" class="mini-btn" style="margin-top:5px; background:#d9534f; color:white;">
                    ğŸ—‘ ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¦è§£æ±º
                </button>
            </div>
        `;
    });
    container.innerHTML = html;
    return container;
}

/**
 * UNIXæ™‚é–“ã‚’èª­ã¿ã‚„ã™ã„å½¢å¼ã«å¤‰æ› (MM/DD HH:mmã€œHH:mm)
 */
function formatTimeRange(start, end) {
    const fmt = (ts) => {
        const d = new Date(ts);
        const mon = d.getMonth() + 1;
        const date = d.getDate();
        const h = d.getHours().toString().padStart(2, '0');
        const m = d.getMinutes().toString().padStart(2, '0');
        return { full: `${mon}/${date} ${h}:${m}`, time: `${h}:${m}` };
    };
    const s = fmt(start);
    const e = fmt(end);
    return `${s.full} ã€œ ${e.time}`;
}
  
</script>
</body>
</html>
