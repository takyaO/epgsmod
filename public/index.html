<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>EPGSmod</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    /* å…¨ä½“è¨­å®š */
    body { 
        font-family: 'Segoe UI', 'Hiragino Kaku Gothic ProN', sans-serif; 
        max-width: 600px; 
        margin: auto; 
        padding: 20px 15px; 
        background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
        color: #333;
        line-height: 1.6;
    }
    
    /* è¦‹å‡ºã— */
    h1 { 
        font-size: 1.5rem; 
        text-align: center; 
        margin: 0 0 25px 0;
        padding: 15px 0;
        background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    h3 {
        margin: 0 0 15px 0;
        font-size: 1.1rem;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    h3::before {
        content: '';
        display: inline-block;
        width: 4px;
        height: 18px;
        background: #4b6cb7;
        border-radius: 2px;
    }
    
    /* ã‚«ãƒ¼ãƒ‰ */
    .card { 
        background: white; 
        padding: 20px; 
        border-radius: 10px; 
        margin-bottom: 20px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border: 1px solid #e1e8ed;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    
    /* å…±é€šãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
    select, input[type="url"], input[type="text"] { 
        width: 100%; 
        margin-top: 8px; 
        padding: 12px 15px; 
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        font-size: 0.95rem;
        transition: border-color 0.2s;
        box-sizing: border-box;
    }
    
    select:focus, input[type="url"]:focus, input[type="text"]:focus {
        outline: none;
        border-color: #4b6cb7;
        box-shadow: 0 0 0 3px rgba(75, 108, 183, 0.1);
    }
    
    /* ãƒœã‚¿ãƒ³åŸºæœ¬ */
    button {
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        box-sizing: border-box;
    }
    
    /* ãƒ—ãƒ©ã‚¤ãƒãƒªãƒœã‚¿ãƒ³ */
    button:not(.mini-btn) {
        background: linear-gradient(90deg, #4b6cb7 0%, #3a56a4 100%);
        color: white;
        width: 100%;
        margin-top: 12px;
    }
    
    button:not(.mini-btn):hover {
        background: linear-gradient(90deg, #3a56a4 0%, #2d468c 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(58, 86, 164, 0.3);
    }
    
    /* ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒœã‚¿ãƒ³ */
    button.mini-btn {
        padding: 6px 12px;
        font-size: 0.85rem;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        color: #495057;
        white-space: nowrap;
    }
    
    button.mini-btn:hover {
        background: #e9ecef;
        border-color: #ced4da;
    }
    
    /* å±é™ºãƒœã‚¿ãƒ³ */
    button[style*="background-color: #d9534f"] {
        background: linear-gradient(90deg, #d9534f 0%, #c9302c 100%) !important;
        color: white !important;
    }
    
    button[style*="background-color: #d9534f"]:hover {
        background: linear-gradient(90deg, #c9302c 0%, #ac2925 100%) !important;
    }
    
    /* æˆåŠŸãƒœã‚¿ãƒ³ */
    button[style*="background:#17a2b8"] {
        background: linear-gradient(90deg, #17a2b8 0%, #138496 100%) !important;
    }
    
    /* è¡Œãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .row {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .row input[type="url"] {
        flex: 1;
        margin: 0;
    }
    
    .row button {
        flex: 0 0 auto;
        width: auto;
        padding: 12px 20px;
        margin: 0;
        white-space: nowrap;
    }
    
    /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
    .compact-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin: 8px 0;
    }
    
    .compact-buttons .mini-btn {
        flex: 1;
        min-width: 70px;
        padding: 8px 10px;
    }
    
    /* ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒªã‚¹ãƒˆ */
    #programList {
        width: 100%;
        min-height: 180px;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        padding: 5px;
        font-size: 0.9rem;
        margin-top: 8px;
        box-sizing: border-box;
    }
    
    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
    input[type="checkbox"] {
        width: 16px;
        height: 16px;
        margin: 0 8px 0 0;
        vertical-align: middle;
    }
    
    /* ãƒ­ã‚°è¡¨ç¤º */
    #log { 
        background: #1a1a1a; 
        color: #4ade80; 
        padding: 15px; 
        height: 180px; 
        overflow-y: auto;
        border-radius: 6px;
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 0.85rem;
        line-height: 1.5;
        border: 1px solid #333;
        white-space: pre-wrap;
        word-break: break-all;
    }
    
    /* ç«¶åˆãƒªã‚¹ãƒˆ */
    #conflictList {
        margin-top: 15px;
    }
    
    #conflictList > div {
        border: 1px solid #ffcdd2;
        padding: 15px;
        margin-bottom: 12px;
        border-radius: 6px;
        background-color: #fff5f5;
    }
    
    /* ãƒ«ãƒ¼ãƒ«ä¸€è¦§ */
    #ruleList {
        margin-top: 15px;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e1e8ed;
        border-radius: 6px;
        padding: 10px;
        background: #f8f9fa;
    }
    
    #ruleList > div {
        border-bottom: 1px solid #e9ecef;
        padding: 12px 8px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    
    #ruleList > div:last-child {
        border-bottom: none;
    }
    
    /* èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ */
    .description {
        font-size: 0.9rem;
        color: #6c757d;
        margin: 8px 0 15px 0;
        line-height: 1.5;
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
    @media (max-width: 480px) {
        body {
            padding: 15px 10px;
        }
        
        .card {
            padding: 15px;
        }
        
        h1 {
            font-size: 1.3rem;
            padding: 12px 0;
        }
        
        select, input[type="url"], input[type="text"], button {
            padding: 10px 12px;
        }
        
        .compact-buttons {
            gap: 4px;
        }
        
        .compact-buttons .mini-btn {
            min-width: 60px;
            font-size: 0.8rem;
            padding: 6px 8px;
        }
    }
</style>
</head>
<body>

<h1>ğŸ“º EPGSmod éŒ²ç”»äºˆç´„</h1>

<div class="card">
    <h3>ğŸŒ EPGStationè¨­å®š</h3>
    <div class="row">
        <input type="url" id="epgApiUrl" value="http://localhost:8888" placeholder="ä¾‹: http://localhost:8888">
        <button onclick="saveApiUrl()">ä¿å­˜</button>
    </div>
</div>

<div class="card">
    <h3>1. ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠ</h3>
    <select id="limitSelect">
      <option value="10">10 ä»¶</option>
      <option value="50">50 ä»¶</option>
      <option value="100">100 ä»¶</option>
      <option value="200" selected>200 ä»¶</option>
    </select>
    <select id="genreSelect"></select>
    <button onclick="searchSchedules()">æ¤œç´¢</button>
</div>

<div class="card">
    <h3>2. ç•ªçµ„é¸æŠ</h3>
    <select id="programList" size="6" onchange="selectProgram()"></select>
    
    <div style="margin-top:10px;">
        <label style="display:flex; align-items:center; gap:6px; font-size:0.9rem;">
            <input type="checkbox" id="filterNewCheck" onchange="filterNewOnly()">
            ï¼»æ–°ï¼½ã®ã¿è¡¨ç¤º
        </label>
    </div>
</div>

<div class="card">
    <h3>3. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰éŒ²ç”»ãƒ«ãƒ¼ãƒ«è¿½åŠ </h3>
    <input id="keywordInput" placeholder="ç•ªçµ„åãŒå…¥ã‚Šã¾ã™" style="
        width: 100%;
        margin: 8px 0 12px 0;
        padding: 14px 15px;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        font-size: 1.1rem;
        font-weight: 500;
        box-sizing: border-box;
        transition: border-color 0.2s;
    ">
    
    <div id="keywordSearchButtons" class="compact-buttons">
        <button class="mini-btn" onclick="searchExternal('duck')">Duck</button>
        <button class="mini-btn" onclick="searchExternal('google')">Google</button>
        <button class="mini-btn" onclick="searchExternal('wiki')">Wiki</button>
        <button class="mini-btn" onclick="searchExternal('tmdb')">TMDB</button>
    </div>
    
    <button onclick="addRule()">
        ğŸ“ éŒ²ç”»ãƒ«ãƒ¼ãƒ«è¿½åŠ 
    </button>
</div>

<div class="card">
    <h3>4. ç«¶åˆãƒã‚§ãƒƒã‚¯</h3>
    <div class="description">
        ç«¶åˆã«ã‚ˆã‚Šäºˆç´„ã§ããªã‹ã£ãŸç•ªçµ„ã¨ã€ãã®åŸå› ã¨ãªã£ã¦ã„ã‚‹äºˆç´„ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
    </div>
    <button onclick="checkConflicts()" style="background-color: #d9534f; color: white;">
        âš  ç«¶åˆã‚’ç¢ºèªã™ã‚‹
    </button>
    <div id="conflictList" style="margin-top:15px;"></div>
</div>

<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>5. ãƒ«ãƒ¼ãƒ«ä¸€è¦§</h3>
        <button onclick="fetchRules()" class="mini-btn" style="width:auto; background:#17a2b8; color:white;">
            ğŸ”„ æ›´æ–°
        </button>
    </div>
    <div id="ruleList">
        <p style="color:#666; text-align:center; padding:10px;">ã€Œæ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ«ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚</p>
    </div>
</div>

<div class="card">
    <h3>ğŸ“‹ ãƒ­ã‚°</h3>
    <div id="log">Ready...</div>
</div>

<script src="extractProgram.js"></script>
<script>
// ====================================================================
// â–¼â–¼â–¼ API URLç®¡ç†ã®ãŸã‚ã®å¤‰æ•°ã®å®šç¾©ã¨é–¢æ•°ã®è¿½åŠ  â–¼â–¼â–¼
// ====================================================================

// APIãƒ™ãƒ¼ã‚¹URLã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let EPG_API_BASE = 'http://localhost:8888';
let originalProgramList = [];

// URLå…¥åŠ›æ¬„ã®å€¤ã‚’èª­ã¿è¾¼ã¿ã€å¤‰æ•°ã¨LocalStorageã«ä¿å­˜ã™ã‚‹é–¢æ•°
function saveApiUrl() {
    const inputElement = document.getElementById('epgApiUrl');
    // æœ«å°¾ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã€å¤‰æ•°ã«æ ¼ç´
    EPG_API_BASE = inputElement.value.trim().replace(/\/$/, '');
    alert(`EPGStation API URLã‚’ ${EPG_API_BASE} ã«è¨­å®šã—ã¾ã—ãŸã€‚`);
    // LocalStorageã«ä¿å­˜
    localStorage.setItem('epgApiUrl', EPG_API_BASE);
    log(`API URLè¨­å®š: ${EPG_API_BASE}`);
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
document.addEventListener('DOMContentLoaded', () => {
    const savedUrl = localStorage.getItem('epgApiUrl');
    const inputElement = document.getElementById('epgApiUrl');

    // LocalStorageã«ä¿å­˜ã•ã‚ŒãŸURLãŒã‚ã‚Œã°å¾©å…ƒ
    if (savedUrl && inputElement) {
        inputElement.value = savedUrl;
        EPG_API_BASE = savedUrl;
    }
    log(`åˆæœŸAPI URL: ${EPG_API_BASE}`);

    // æ—¢å­˜ã®ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠè‚¢ã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
    const genreSelect = document.getElementById('genreSelect');
    for (const [k,v] of Object.entries(genreMap)) {
        const op = document.createElement('option');
        op.value = k; op.textContent = v;
        genreSelect.appendChild(op);
    }
    genreSelect.value = "7";
});


// ====================================================================
// â–²â–²â–² API URLç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚ã‚ã‚Š â–²â–²â–²
// ====================================================================

const genreMap = {
    0:"ãƒ‹ãƒ¥ãƒ¼ã‚¹",1:"ã‚¹ãƒãƒ¼ãƒ„",2:"æƒ…å ±",3:"ãƒ‰ãƒ©ãƒ",
    4:"éŸ³æ¥½",5:"ãƒãƒ©ã‚¨ãƒ†ã‚£",6:"æ˜ ç”»",7:"ã‚¢ãƒ‹ãƒ¡/ç‰¹æ’®",
    8:"ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼",9:"åŠ‡å ´/å…¬æ¼”",10:"è¶£å‘³/æ•™è‚²",11:"ç¦ç¥‰"
};

// genreSelectã®åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯ã¯DOMContentLoadedå†…ã«ç§»å‹•ã—ã¾ã—ãŸ

function log(msg){
    const el = document.getElementById('log');
    el.innerText = `[${new Date().toLocaleTimeString()}] ${msg}\n` + el.innerText;
}

async function searchSchedules(){
    const genreId = Number(genreSelect.value);

    // â˜… ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã® limit ã‚’å–å¾—
    const limit = Number(document.getElementById('limitSelect').value);

    const payload = {
        epgApiBase: EPG_API_BASE,
        isHalfWidth: false,
        option: {
            keyword: "",
            name: true, description: true, extended: true,
            GR: true, BS: true, CS: true, SKY: true,

            // subGenre ã‚’å¤–ã™ï¼ˆä»»æ„æ‰±ã„ï¼‰
            genres: [{ genre: genreId }]
        },

        // â˜… é¸æŠã•ã‚ŒãŸ limit ã‚’åæ˜ 
        limit: limit
    };

    try {
        const res = await fetch('/proxy/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (data && data.error) {
            log("æ¤œç´¢ã‚¨ãƒ©ãƒ¼: " + data.error);
            alert("æ¤œç´¢å¤±æ•—: " + data.error);
            return;
        }

        updateList(data);
        log(`æ¤œç´¢å®Œäº†: ${data.length} ä»¶`);
    } catch(e){
        log("æ¤œç´¢ã‚¨ãƒ©ãƒ¼: " + e.message);
        alert("æ¤œç´¢å¤±æ•—");
    }
}


function updateList(list){
    const box = document.getElementById('programList');
    box.innerHTML = "";

    if (!Array.isArray(list)) {
        originalProgramList = [];
        return;
    }

    // 1) å—ã‘å–ã£ãŸä¸€è¦§ã‚’åŸæœ¬ã¨ã—ã¦ä¿æŒï¼ˆfilteråˆ‡æ›¿ã«ä½¿ç”¨ï¼‰
    originalProgramList = list.slice();

    // 2) åå‰æœ‰ã‚Šã®è¦ç´ ã ã‘å–ã‚Šå‡ºã—ã¦æ—¥æœ¬èªã‚½ãƒ¼ãƒˆ
    const filteredAndSorted = originalProgramList
        .filter(p => p && p.name) // p ãŒå­˜åœ¨ã— name ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
        .sort((a, b) => a.name.localeCompare(b.name, 'ja'));

    // â–¼è¿½åŠ : æ›œæ—¥ã®å®šç¾©
    const wdayList = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

    // 3) è¡¨ç¤ºç”¨ã« option ã‚’ä½œæˆï¼ˆé–‹å§‹æ—¥æ™‚ãŒã‚ã‚Œã°è¡¨ç¤ºã«å«ã‚ã‚‹ï¼‰
    filteredAndSorted.forEach(p => {
        const op = document.createElement('option');

        // startAt ãŒã‚ã‚‹ï¼æœ‰åŠ¹ãªæ—¥ä»˜ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        let startTime = "";
        if (p.startAt) {
            const d = new Date(p.startAt);
            if (!Number.isNaN(d.getTime())) {
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                const hh = String(d.getHours()).padStart(2, '0');
                const mi = String(d.getMinutes()).padStart(2, '0');

                // â–¼è¿½åŠ : æ›œæ—¥ã‚’å–å¾—
                const wday = wdayList[d.getDay()];

                // â–¼å¤‰æ›´: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«æ›œæ—¥ã‚’è¿½åŠ  (ä¾‹: 12/10(æ°´) 18:00)
                startTime = `${mm}/${dd}(${wday}) ${hh}:${mi}`;
            }
        }

        op.value = p.name; // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã«ä½¿ã†å€¤ã¯ç•ªçµ„åã®ã¿
        op.textContent = startTime ? `[${startTime}] ${p.name}` : p.name;
        box.appendChild(op);
    });

    // 4) ç¾åœ¨ã€Œï¼»æ–°ï¼½ã®ã¿è¡¨ç¤ºã€ãŒã‚ªãƒ³ãªã‚‰çµã‚Šè¾¼ã‚€ï¼ˆåˆ‡æ›¿å¾Œã‚‚ä¸€è²«ã—ã¦å‹•ã‹ã™ãŸã‚ï¼‰
    const chk = document.getElementById('filterNewCheck');
    if (chk && chk.checked) {
        filterNewOnly(); // æ—¢ã«ç”¨æ„ã—ãŸé–¢æ•°ã‚’åˆ©ç”¨
    }
}

function filterNewOnly() {
    const listBox = document.getElementById("programList");
    listBox.innerHTML = "";

    if (!Array.isArray(originalProgramList)) return;

    const filter = document.getElementById('filterNewCheck').checked;

    let filtered = originalProgramList;
    if (filter) {
        filtered = originalProgramList.filter(x => {
            const n = x && x.name ? x.name : "";
            return n.includes("ï¼»æ–°ï¼½") || n.includes("[æ–°]");
        });
    }

    const wdayList = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

    filtered.forEach(p => {
        if (!p || !p.name) return;
        const op = document.createElement("option");

        let startTime = "";
        if (p.startAt) {
            const d = new Date(p.startAt);
            if (!Number.isNaN(d.getTime())) {
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                const hh = String(d.getHours()).padStart(2, '0');
                const mi = String(d.getMinutes()).padStart(2, '0');
                const wday = wdayList[d.getDay()];

                startTime = `${mm}/${dd}(${wday}) ${hh}:${mi}`;
            }
        }

        op.value = p.name;
        op.textContent = startTime ? `[${startTime}] ${p.name}` : p.name;
        listBox.appendChild(op);
    });
}

function selectProgram(){
    // å…ƒã®å‡¦ç†:
//    document.getElementById('keywordInput').value = document.getElementById('programList').value;

    // â–¼â–¼â–¼ å¤‰æ›´: ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’é€šã—ã¦ã‹ã‚‰ã‚»ãƒƒãƒˆã™ã‚‹ â–¼â–¼â–¼
    const rawName = document.getElementById('programList').value;
    const cleanName = extractProgram(rawName);
    document.getElementById('keywordInput').value = cleanName;
}

async function addRule(){
    const keyword = document.getElementById('keywordInput').value;
    if (!keyword) return alert("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›");

    if (!EPG_API_BASE || EPG_API_BASE.trim() === '') {
        log("ã‚¨ãƒ©ãƒ¼: EPG API URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        alert("EPG API URLã‚’è¨­å®šã—ã€[URLã‚’ä¿å­˜]ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    if (!confirm(`ã€Œ${keyword}ã€ã‚’ãƒ«ãƒ¼ãƒ«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) return;

    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: EPG_API_BASEã‚’JSONãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ  â˜…â˜…â˜…
    const payload = {
        // EPG_API_BASEã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¼ãˆã‚‹ãŸã‚ã«è¿½åŠ 
        epgApiBase: EPG_API_BASE,

        isTimeSpecification: false,
        searchOption: {
            keyword,
            name: true, description: true, extended: true,
            GR: true, BS: true, CS: true
        },
        reserveOption: {
            enable: true,
            allowEndLack: false,
            avoidDuplicate: true
        }
    };

    try {
        const r = await fetch('/proxy/rule', {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const data = await r.json();

        if (data && data.error) {
            log(`è¿½åŠ ã‚¨ãƒ©ãƒ¼: ${data.error}`);
            alert(`è¿½åŠ å¤±æ•—: ${data.error}`);
            return;
        }

        log(`è¿½åŠ  OK: ãƒ«ãƒ¼ãƒ«ID ${data.id}`);
        alert("è¿½åŠ ã—ã¾ã—ãŸï¼");
    } catch(e){
        log("è¿½åŠ ã‚¨ãƒ©ãƒ¼: " + e.message);
        alert("è¿½åŠ å¤±æ•—");
    }
}
function searchExternal(type) {
    const keyword = document.getElementById('keywordInput').value.trim();
    if (!keyword) {
        alert("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
    }

    let url = "";
    const q = encodeURIComponent(keyword);

    switch (type) {
        case "duck":
            url = `https://duckduckgo.com/?q=${q}`;
            break;
        case "google":
            url = `https://www.google.com/search?q=${q}`;
            break;
        case "wiki":
            url = `https://ja.wikipedia.org/wiki/Special:Search?search=${q}`;
            break;
        case "tmdb":
            url = `https://www.themoviedb.org/search?query=${keyword}`;
            break;
    }

    window.open(url, "_blank");
}
// â–¼â–¼â–¼ 4. ç«¶åˆãƒ«ãƒ¼ãƒ«ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ â–¼â–¼â–¼

/**
 * ç«¶åˆæƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
 */
async function checkConflicts() {
    const logDiv = document.getElementById('log');
    const listDiv = document.getElementById('conflictList');
    const apiUrl = document.getElementById('epgApiUrl').value.replace(/\/$/, '');

    listDiv.innerHTML = '<p>æ¤œç´¢ä¸­...</p>';
    logDiv.innerText = 'ç«¶åˆæƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™(ProxyçµŒç”±)...';

    try {
        // 1. ç«¶åˆã§è½ã¡ãŸäºˆç´„ã‚’å–å¾— (ProxyçµŒç”±)
        const conflictData = await fetchReservesViaProxy(apiUrl, 'conflict');

        // 2. æœ‰åŠ¹ãªäºˆç´„ã‚’å–å¾— (ProxyçµŒç”±)
        const activeData = await fetchReservesViaProxy(apiUrl, 'normal');

        const lostReserves = conflictData.reserves || [];
        const keptReserves = activeData.reserves || [];

        listDiv.innerHTML = ''; // ã‚¯ãƒªã‚¢

        if (lostReserves.length === 0) {
            listDiv.innerHTML = '<p style="text-align:center; color:#28a745;">ç¾åœ¨ã€ç«¶åˆã—ã¦ã„ã‚‹äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            logDiv.innerText = 'ç«¶åˆãªã—';
            return;
        }

        // 3. ãƒãƒƒãƒãƒ³ã‚°å‡¦ç†ã¨è¡¨ç¤º (ã“ã“ã¯å¤‰æ›´ãªã—)
        let count = 0;
        lostReserves.forEach(lost => {
            const enemies = keptReserves.filter(kept => {
                return (lost.startAt < kept.endAt) && (lost.endAt > kept.startAt);
            });

            if (enemies.length > 0) {
                count++;
                const card = createConflictCard(lost, enemies);
                listDiv.appendChild(card);
            }
        });

        if (count === 0) {
             listDiv.innerHTML = '<p>ç«¶åˆãƒªã‚¹ãƒˆã«ã¯ã‚ã‚Šã¾ã™ãŒã€ç¾åœ¨ã®æœ‰åŠ¹äºˆç´„ã¨é‡ãªã‚‹ã‚‚ã®ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
        }
        logDiv.innerText = `ç«¶åˆãƒã‚§ãƒƒã‚¯å®Œäº†: ${count} ä»¶ã®ç«¶åˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚`;

    } catch (err) {
        console.error(err);
        listDiv.innerHTML = `<p style="color:red">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}</p>`;
        logDiv.innerText = `ã‚¨ãƒ©ãƒ¼: ${err.message}`;
    }
}

/**
 * ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§äºˆç´„ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 */
async function fetchReservesViaProxy(epgApiBase, type) {
    const limit = type === 'conflict' ? 50 : 2000;

    // æ¤œç´¢æ©Ÿèƒ½ã¨åŒã˜å½¢å¼ã§ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆ
    const payload = {
        epgApiBase: epgApiBase,
        type: type,
        limit: limit
    };

    const res = await fetch('/proxy/reserves', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    if (!res.ok) {
        const errText = await res.text();
        throw new Error(`Server Error (${res.status}): ${errText}`);
    }
    return await res.json();
}

/**
 * äºˆç´„å‰Šé™¤ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•° (ProxyçµŒç”±)
 */
async function deleteReserve(reserveId, name) {
    if(!confirm(`ä»¥ä¸‹ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã€Œ${name}ã€`)) return;

    const logDiv = document.getElementById('log');
    const apiUrl = document.getElementById('epgApiUrl').value.replace(/\/$/, '');

    try {
        const payload = {
            epgApiBase: apiUrl,
            reserveId: reserveId
        };

        const res = await fetch('/proxy/reserves/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            logDiv.innerText = `å‰Šé™¤æˆåŠŸ: ${name}`;
            alert('å‰Šé™¤ã—ã¾ã—ãŸã€‚ç«¶åˆãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã™ã€‚');
            checkConflicts(); // ãƒªã‚¹ãƒˆå†å–å¾—
        } else {
            throw new Error(`Status: ${res.status}`);
        }
    } catch (err) {
        alert(`å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
        logDiv.innerText = `å‰Šé™¤å¤±æ•—: ${err.message}`;
    }
}


/**
 * ç«¶åˆè¡¨ç¤ºç”¨ã®ã‚«ãƒ¼ãƒ‰HTMLè¦ç´ ã‚’ä½œæˆ
 */
function createConflictCard(lost, enemies) {
    const container = document.createElement('div');
    container.style.cssText = "border:1px solid #ffcdd2; padding:15px; margin-bottom:12px; border-radius:6px; background-color:#fff5f5;";

    // A. éŒ²ç”»ã§ããªã‹ã£ãŸç•ªçµ„
    let html = `
        <div style="margin-bottom:12px; padding-bottom:12px; border-bottom:1px dashed #ffcdd2;">
            <div style="font-weight:bold; color:#d9534f; font-size:0.95rem;">âŒ éŒ²ç”»ä¸å¯ (ç«¶åˆ):</div>
            <div style="font-size:1.05em; margin:6px 0;">${lost.name}</div>
            <div style="font-size:0.85em; color:#666;">${formatTimeRange(lost.startAt, lost.endAt)}</div>
            <div style="margin-top:10px;">
                <button onclick="deleteReserve(${lost.id}, '${lost.name}')" class="mini-btn" style="background:#666; color:white; width:auto;">äºˆç´„å–æ¶ˆ</button>
            </div>
        </div>
    `;

    // B. åŸå› ã®ç•ªçµ„
    html += `<div style="font-weight:bold; color:#28a745; margin-bottom:8px; font-size:0.95rem;">âœ… å„ªå…ˆã•ã‚ŒãŸäºˆç´„ (åŸå› ):</div>`;
    
    enemies.forEach(enemy => {
        html += `
            <div style="background:white; padding:12px; border-radius:6px; margin-bottom:10px; border-left: 4px solid #28a745;">
                <div style="font-weight:600;">${enemy.name}</div>
                <div style="font-size:0.85em; color:#666; margin:5px 0;">${formatTimeRange(enemy.startAt, enemy.endAt)}</div>
                <button onclick="deleteReserve(${enemy.id}, '${enemy.name}')" class="mini-btn" style="margin-top:8px; background:#d9534f; color:white; width:auto;">
                    ğŸ—‘ ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¦è§£æ±º
                </button>
            </div>
        `;
    });

    container.innerHTML = html;
    return container;
}

/**
 * UNIXæ™‚é–“ã‚’èª­ã¿ã‚„ã™ã„å½¢å¼ã«å¤‰æ› (MM/DD HH:mmã€œHH:mm)
 */
function formatTimeRange(start, end) {
    const fmt = (ts) => {
        const d = new Date(ts);
        const mon = d.getMonth() + 1;
        const date = d.getDate();
        const h = d.getHours().toString().padStart(2, '0');
        const m = d.getMinutes().toString().padStart(2, '0');
        return { full: `${mon}/${date} ${h}:${m}`, time: `${h}:${m}` };
    };
    const s = fmt(start);
    const e = fmt(end);
    return `${s.full} ã€œ ${e.time}`;
}

/**
 * ãƒ«ãƒ¼ãƒ«ä¸€è¦§ã‚’å–å¾— (ProxyçµŒç”±)
 */
async function fetchRules() {
    const listDiv = document.getElementById('ruleList');
    const apiUrl = document.getElementById('epgApiUrl').value.replace(/\/$/, '');

    listDiv.innerHTML = '<p>ãƒ«ãƒ¼ãƒ«ã‚’å–å¾—ä¸­...</p>';

    try {
        const payload = { epgApiBase: apiUrl };

        // ProxyçµŒç”±ã§ãƒ«ãƒ¼ãƒ«å–å¾—
        const res = await fetch('/proxy/rules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || res.statusText);
        }

        const data = await res.json();
        const rules = data.rules || [];

        renderRuleList(rules);
        log(`ãƒ«ãƒ¼ãƒ«ä¸€è¦§å–å¾—å®Œäº†: ${rules.length}ä»¶`);

    } catch (e) {
        console.error(e);
        listDiv.innerHTML = `<p style="color:red;">å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}</p>`;
        log(`ãƒ«ãƒ¼ãƒ«å–å¾—å¤±æ•—: ${e.message}`);
    }
}


/**
 * ãƒ«ãƒ¼ãƒ«ä¸€è¦§ã‚’HTMLè¡¨ç¤º (ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ç‰ˆ)
 * - enable:false ã®ãƒ«ãƒ¼ãƒ«ã‚’é™¤å¤–
 * - ã‚·ãƒ³ãƒ—ãƒ«ãªçµµæ–‡å­—ã‚’å†å°å…¥ (ğŸ”, ğŸ“š, â“)
 * - å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚µã‚¤ã‚ºã¨é…ç½®ã‚’æœ€é©åŒ–
 */
function renderRuleList(rules) {
    const listDiv = document.getElementById('ruleList');
    listDiv.innerHTML = '';

    // 1. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ«ãƒ¼ãƒ«(enable: true)ã®ã¿ã‚’æŠ½å‡º
    const activeRules = rules.filter(r => r.reserveOption && r.reserveOption.enable === true);

    if (activeRules.length === 0) {
        listDiv.innerHTML = '<p style="color:#666; text-align:center; padding: 10px;">ç¾åœ¨ã€æœ‰åŠ¹ãªè‡ªå‹•äºˆç´„ãƒ«ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
    }

    // IDã®é™é †ï¼ˆæ–°ã—ã„é †ï¼‰ã§è¡¨ç¤º
    activeRules.sort((a, b) => b.id - a.id).forEach(rule => {
        const sOpt = rule.searchOption || {};

        // --- è¡¨ç¤ºå†…å®¹ã®çµ„ã¿ç«‹ã¦ ---
        let mainCondition = "";
        let icon = "";

        if (sOpt.keyword) {
            icon = "ğŸ”"; // æ¤œç´¢
            mainCondition = `<span style="font-weight:bold; color:#333;">${escapeHtml(sOpt.keyword)}</span>`;
        } else if (sOpt.genres && sOpt.genres.length > 0) {
            icon = "ğŸ“š"; // ã‚¸ãƒ£ãƒ³ãƒ«
            const gName = (typeof genreMap !== 'undefined') ? genreMap[sOpt.genres[0].genre] : sOpt.genres[0].genre;
            mainCondition = `<span style="font-weight:bold;">${gName}</span>`;
        } else {
            icon = "â“"; // ãã®ä»–
            mainCondition = `<span style="font-style:italic; color:#888;">æ¡ä»¶ãªã— (å…¨éŒ²ç”»?)</span>`;
        }

        // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
        let ignoreInfo = "";
        if (sOpt.ignoreKeyword) {
            ignoreInfo = `<div style="font-size:0.85em; color:#d9534f; margin-top:2px;">ğŸš« é™¤å¤–: ${escapeHtml(sOpt.ignoreKeyword)}</div>`;
        }

        // æ”¾é€å±€æŒ‡å®š
        let channelInfo = "";
        if (sOpt.channelIds && sOpt.channelIds.length > 0) {
            channelInfo = `<span style="font-size:0.75em; color:#0056b3; margin-left:8px;">${sOpt.channelIds.length}å±€æŒ‡å®š</span>`;
        }

        // --- HTMLç”Ÿæˆ (Flexboxã§ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´) ---
        const item = document.createElement('div');
        item.style.cssText = "display:flex; justify-content:space-between; align-items:flex-start; padding:12px 8px; border-bottom:1px solid #e9ecef;";

        item.innerHTML = `
            <div style="flex: 1; padding-right: 15px;">
                <div style="font-size:0.95rem; line-height:1.4; word-break:break-all;">
                    ${icon} ${mainCondition} ${channelInfo}
                </div>
                ${ignoreInfo}
            </div>

            <div style="flex-shrink: 0;">
                <button onclick="deleteRule(${rule.id})" class="mini-btn" style="
                    background-color: #f8f9fa;
                    color: #d9534f;
                    border: 1px solid #d9534f;
                    padding: 6px 12px;
                    font-size: 0.85rem;
                    border-radius: 4px;
                    cursor: pointer;
                    white-space: nowrap;
                ">
                    å‰Šé™¤
                </button>
            </div>
        `;
        listDiv.appendChild(item);
    });
}

/**
 * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
function escapeHtml(str) {
    if(!str) return "";
    return str.replace(/[&<>"']/g, function(m) {
        return {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        }[m];
    });
}

/**
 * ãƒ«ãƒ¼ãƒ«å‰Šé™¤ (ProxyçµŒç”±)
 */
async function deleteRule(ruleId) {
    if (!confirm(`å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã‚‹å°†æ¥ã®äºˆç´„ã‚‚è§£é™¤ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`)) {
        return;
    }

    const apiUrl = document.getElementById('epgApiUrl').value.replace(/\/$/, '');

    try {
        const payload = {
            epgApiBase: apiUrl,
            ruleId: ruleId
        };

        const res = await fetch('/proxy/rules/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            log(`ãƒ«ãƒ¼ãƒ«å‰Šé™¤æˆåŠŸ: ID ${ruleId}`);
            alert(`ãƒ«ãƒ¼ãƒ« ID ${ruleId} ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
            fetchRules(); // ãƒªã‚¹ãƒˆæ›´æ–°
        } else {
            const err = await res.json();
            throw new Error(err.error || res.statusText);
        }
    } catch (e) {
        alert(`å‰Šé™¤å¤±æ•—: ${e.message}`);
        log(`ãƒ«ãƒ¼ãƒ«å‰Šé™¤å¤±æ•—: ${e.message}`);
    }
}

</script>
</body>
</html>
